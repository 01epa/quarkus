
 = Using Web Sockets

This guide explains how your Shamrock application can utilize web socket to create interactive web applications.
Because it's the _canonical_ web socket application, we are going to create a simple chat application.

== Prerequisites

To complete this guide, you need:

* less than 15 minutes
* an IDE
* JDK 1.8+ installed with `JAVA_HOME` configured appropriately
* Apache Maven 3.5+

== Architecture

In this guide, we create a straightforward chat application using web sockets to receive and send messages to the other connected users.

image:websocket-guide-architecture.png[alt=Architecture,width=640,height=480]

== Solution

We recommend you to follow the instructions in the next sections and create the application step by step.
However, you can go right to the completed example.

Clone the Git repository: `git clone https://github.com/protean-project/quickstarts.git`, or download an http://https://github.com/protean-project/quickstarts/archive/master.zip[archive].

The solution is located in the `using-websocket` https://github.com/protean-project/quickstarts/tree/master/using-websockets[directory].

== Creating the Maven project

First, we need a new project. Create a new project with the following command:

```
mvn org.jboss.shamrock:shamrock-maven-plugin:1.0.0.Alpha1-SNAPSHOT:create \
    -DprojectGroupId=org.acme \
    -DprojectArtifactId=using-websockets \
    -DclassName="org.acme.websocket.HelloResource" \
    -Dpath="/hello" \
    -Dextensions="websockets"
```

It generates:

* the maven structure
* an `org.acme.websocket.HelloResource` resource
* an associated test

The maven project also imports the Shamrock WebSocket extension.

== Handling web sockets

In the `org.acme.websocket` package, create the `ChatSocket` class, with the following content:

[source,java]
----
package org.acme.websocket;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import javax.enterprise.context.ApplicationScoped;
import javax.websocket.OnClose;
import javax.websocket.OnError;
import javax.websocket.OnMessage;
import javax.websocket.OnOpen;
import javax.websocket.server.PathParam;
import javax.websocket.server.ServerEndpoint;
import javax.websocket.Session;

@ServerEndpoint("/chat/{username}")         // <1>
@ApplicationScoped
public class ChatManager {

    Map<String, Session> sessions = new ConcurrentHashMap<>(); // <2>

    @OnOpen
    public void opening(Session session, @PathParam("username") String username) {
        sessions.put(username, session);
        broadcast("User " + username + " joined");
    }

    @OnClose
    public void closing(Session session, @PathParam("username") String username) {
        sessions.remove(username);
        broadcast("User " + username + " left");
    }

    @OnError
    public void errored(Session session, @PathParam("username") String username, Throwable throwable) {
        sessions.remove(username);
        broadcast("User " + username + " left on error: " + throwable);
    }

    @OnMessage
    public void onMessage(String message, @PathParam("username") String username) {
        broadcast(">> " + username + ": " + message);
    }

    private void broadcast(String message) {
        sessions.values().forEach(s -> {
            s.getAsyncRemote().sendObject(message, result ->  {
                if (result.getException() != null) {
                    System.out.println("Unable to send message: " + result.getException());
                }
            });
        });
    }

}
----
1. Configures the web socket URL
2. Stores the currently opened web sockets

== A slick web frontend

All chat applications need a _nice_ UI, well this one may not be that nice, but should do the work.
The first things to do is to configure our application to serve static resources.
Edit the `HelloResource.java` file and add the following method:

[source,java]
----
@GET
@Path("/assets/{path: .*}")
public Response staticResources(@PathParam("path") final String path) {
    InputStream resource = HelloResource.class.getClassLoader().getResourceAsStream("/assets/" + path);
    return resource == null ? Response.status(404).build() : Response.ok().entity(resource).build();
}
----

This method serves any files located into the `assets` directory.

Now, create the `assets` directory in `src/main/resources` and, in this newly created directory, copy this https://github.com/protean-project/quickstarts/blob/master/using-websockets/src/main/resources/assets/index.html[index.html] file.

== Run the application

Now, let's see our application in action. Run it with:

```
mvn compile shamrock:run
```

Then open your 2 browser windows to http://localhost:8080/app/hello/assets/index.html:

1. Enter a name in the top text area (use 2 different names).
2. Click on connect
3. Send and receive messages

image:websocket-guide-screenshot.png[alt=Application,width=800]

As usual, the application can be packaged using `mvn clean package` and executed using the `-runner.jar` file.